<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .bar {
        fill: steelblue;
    }

    .bar:hover {
        fill: brown;
    }

    .line {
        fill: none;
        stroke-width: 2px;

    }

    #wage_gap_line {
        stroke:#6c9dc6 ;
    }

    #employ_line {
        stroke: red;
    }

    .emp_dot, #emp_dot_legend {
        stroke: red;
        fill: red
    }

    .wage_dot, #wage_dot_legend {
        stroke: steelblue;
        fill: steelblue

    }

    .axis--y line {
        stroke: #0033cc;
    }

    .axis--y path {
        stroke: #0033cc;
    }

    .axis--y text {
        stroke: #0033cc;
        font-weight: normal;
        font-family: monospace;
        font-size: 1vw;
    }

    .title {
        font-family: "Bebas Neue", "sans-serif";
        font-size: 2.0vw;
        text-anchor: middle;
        font-weight: bold;
        fill: #0033cc;

    }

    .label {
        fill: #FAF8A0;
        font-family: monospace;
        font-size: 1.01vw;
        text-anchor: end;

    }

    body {
        background-color: #FAF8A0;
        padding: 0;
        position: relative;
        bottom: 0;
        margin: 0;
    }


    .chart {
        position: absolute;
        bottom: 0;
        top: 0;
        left: 0;
        padding: 0;
        margin: 0;
    }

    .toolTip {
        position: absolute;
        width: 10.5vw;
        height: auto;
        padding: 0.5%;
        background-color: white;
        -webkit-border-radius: 0.7vw;
        -moz-border-radius: 0.7vw;
        border-radius: 0.7vw;
        -webkit-box-shadow: 0.4vw 0.4vw 1vw rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 0.4vw 0.4vw 1vw rgba(0, 0, 0, 0.4);
        box-shadow: 0.4vw 0.4vw 1vw rgba(0, 0, 0, 0.4);
        pointer-events: none;
    }

    .toolTip .countryValue {
        color: #0033cc;
        font-family: monospace;
        font-size: 1.01vw;
        font-weight: bold;
    }

    .toolTip .countryName {
        color: brown;
        font-family: monospace;
        font-size: 1.01vw;
        font-weight: bold;
    }

    /*code from "https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_modal2"*/
    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 50px; /* Location of the box */
        left: 0;
        top: 0;
        border-radius: 0.7vw;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0, 0, 0); /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        -webkit-animation-name: animatetop;
        -webkit-animation-duration: 0.4s;
        animation-name: animatetop;
        border-radius: 0.7vw;
        animation-duration: 0.4s
    }

    /* Add Animation */
    @-webkit-keyframes animatetop {
        from {
            top: -300px;
            opacity: 0
        }
        to {
            top: 0;
            opacity: 1
        }
    }

    @keyframes animatetop {
        from {
            top: -300px;
            opacity: 0
        }
        to {
            top: 0;
            opacity: 1
        }
    }

    /* The Close Button */
    .close {
        color: #FAF8A0;;
        float: right;
        font-size: 1.5vw;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
        color: white;
    }

    .modal-header {
        padding: 2px 16px;
        background-color: brown;
        color: #FAF8A0;
        font-size: 1.4vw;
        border-radius: 0.7vw;
    }

    .modal-body {
        padding: 2px 16px;
        font-size: 1.2vw;
    }

    .modal-footer {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
    }


</style>
<body>
<svg class="chart"></svg>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="d3.legend.js"></script>
<script>
    var Chart = (function (window, d3) {
        var x, y, x_modal, y_modal;
        d3.csv("data/wagegap_only.csv", initWage);

        function initWage(wage_data) {
            d3.csv("data/employ_rate_final.csv", function (err, emp_data) {
                if (err) console.log("Error loading data " + err);
                else {
                    initAllGraphElements(wage_data, emp_data);
                }
            });
        }

        function initAllGraphElements(wage_data, emp_data) {
            // parse the date / time
            var parseTime = d3.timeParse("%Y");
            wage_data.forEach(function (d) {
                d.TIME = parseTime(d.TIME);
                d.Value = +d.Value;
                //d.genderDiff = +d.genderDiff;

            });

            emp_data.forEach(function (d) {
                d.TIME = parseTime(d.TIME);
                d.Value = +d.Value;

            });

            var data = data_for_year(parseTime("2014"), wage_data);
            data.sort(function (d1, d2) {
                return d1["Value"] - d2["Value"];
            });

            x = d3.scaleBand().domain(data.map(function (d, i) {
                return i;
            }));
            y = d3.scaleLinear().domain([0, d3.max(data, function (d) {
                return d.Value;
            })]);

            var svg = d3.select("svg");
            var g = svg.append("g");

            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "toolTip")
                .style("display", "none");

            var modal = d3.select("body")
                .append("div")
                .attr('id', 'country_modal')
                .attr("class", "modal");

            modal.append("div")
                .attr("class", "modal-content")
                .append("div")
                .attr("class", "modal-header")
                .append("span")
                .attr("class", "close")
                .text("x")
                .on("click", function () {
                    modal.style("display", "none")
                });

            modal.select(".modal-header")
                .append("h2")
                .attr("id", "country_name");

            modal.select(".modal-content")
                .append("div")
                .attr("class", "modal-body");
            modal.select(".modal-body")
                .append("g")
                .append("svg")
                .attr("id", "modal_svg")
                .append("g")
                .attr("id", "modal_inside_g");


            var modal_svg = modal.select("#modal_svg");
            var modal_g = modal_svg.select("#modal_inside_g");
            modal_g.append("path")
                .attr("id", "wage_gap_line")
                .attr("class", "line");


            modal_g.append("path")
                .attr("id", "employ_line")
                .attr("class", "line");


            // Add the X Axis
            modal_g.append("g")
                .attr("id", "x_axis_modal");

            // Add the Y Axis
            modal_g.append("g")
                .attr("id", "y_axis_modal");

            modal_g.append("g")
                .attr("class","legend");

            modal_g.append("text")
                .attr("id","modal_graph_title")
                .text("Gender Wage Gap and Employment Gap Over Time");


          var legend =  modal_g.select(".legend");
          legend.append("g")
                .attr("class", "legend-items")
                .append("text")
                .attr("id", "wage_legend")
                .text("Wage gap as % of male wage");

          legend.select(".legend-items")
              .append("text")
                .text("Employment gap as % of male employment")
                .attr("id", "emp_legend");

          legend.select(".legend-items")
              .append("circle")
              .attr("id", "emp_dot_legend");

            legend.select(".legend-items")
                .append("circle")
                .attr("id", "wage_dot_legend");

            g.append("text")
                .attr("class", "title")
                .text("Gender Wage Gap in OECD Countries");


            g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .on("mousemove", function (d) {
                    tooltip
                        .style("display", "inline-block")
                        .style("left", d3.event.pageX - 70 + "px")
                        .style("top", d3.event.pageY - 70 + "px")
                        .html("<span class = 'countryName'><strong>" + d.Country + ": </strong></span><span class = 'countryValue'>" + Math.round(d.Value) + "%</span>");
                })
                .on("mouseout", function (d) {
                    tooltip.style("display", "none");
                })
                .on("click", function (d) {
                    modal.select("#country_name")
                        .text(d.Country);
                    modal.style("display", "block");
                    create_graph_modal(d.LOCATION, wage_data, emp_data);

                });

            g.selectAll(".label")
                .data(data).enter()
                .append("text")
                .attr("class", "label");

            g.append("g")
                .attr("class", "axis axis--y");

            render();


        }

        function render() {
            var width = window.innerWidth * 0.98;
            var height = window.innerHeight * 0.96;

            d3.select(".chart")
                .attr("width", width)
                .attr("height", height);

            var svg = d3.select("svg");
            var margin = {top: 20, right: 20, bottom: 30, left: 40};
            width = +svg.attr("width") - margin.left - margin.right;
            height = +svg.attr("height") - margin.top - margin.bottom;


            x.rangeRound([0, width]).padding(0.1);
            y.rangeRound([height, 0]);

            var g = svg.select("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            g.selectAll(".title")
                .attr("x", width / 2)
                .attr("y", height * 0.04);

            g.selectAll(".bar")
                .attr("id", function (d) {
                    return d.LOCATION;
                })
                .attr("x", function (d, i) {
                    return x(i);
                })
                .attr("y", function (d) {
                    return y(d.Value);
                })
                .attr("width", x.bandwidth())
                .attr("height", function (d) {
                    return height - y(d.Value);
                });


            g.selectAll(".label")
                .attr("x", function (d, i) {
                    return x(i) + (width * 0.02);
                })
                .attr("y", height - (height * 0.0098))
                .attr("dy", ".35em")
                .text(function (d) {
                    return d.LOCATION;
                });

            g.select(".axis--y")
                .call(d3.axisLeft(y).ticks(10))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .text("Wage gap as a percentage of male wage");


        }

        function data_for_year(year, data) {
            var temp = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if (row['TIME'].getTime() === year.getTime()) {
                    if (row['Value']) temp.push(row);
                }
            }
            return temp;
        }

        function create_graph_modal(country, wage_data, emp_data) {
            var modal_g = d3.select(".modal-body")
                .select("g");
            var svg = modal_g.select("#modal_svg");
            var g = svg.select("#modal_inside_g");


            // Get the data
            wage_data = data_for_country(country, wage_data);
            emp_data = data_for_country(country, emp_data);

            var wage_vals = getMinMaxVals(wage_data);
            var emp_vals =  getMinMaxVals(emp_data);

            // Scale the range of the data
            x_modal = d3.scaleTime().domain(d3.extent(wage_vals[0].concat(emp_vals[0])));

            // x.domain([d3.min(data, function(d) { return d.TIME; }), d3.max(data, function(d) { return d.TIME; })]);
            y_modal = d3.scaleLinear().domain([0, d3.max(wage_vals[1].concat(emp_vals[1]))]);

            // Add the valueline path.
            g.select("#wage_gap_line")
                .data([wage_data])
                .attr("class", "line")
                .attr("data-legend", "Wage Gap");

            g.select("#employ_line")
                .data([emp_data])
                .attr("class", "line")
                .attr("data-legend", "Employment Gap");

            g.selectAll(".wage_dot").remove();

            g.selectAll('dot')
                .data(wage_data)
                .enter().append("circle")
                .attr("class", "wage_dot");

            g.selectAll(".emp_dot").remove();

            g.selectAll("dot")
                .data(emp_data)
                .enter().append("circle")
                .attr("class", "emp_dot");
            render_modal();

        }

        function render_modal() {
            var width = window.innerWidth * 0.98 * 0.8;
            var height = window.innerHeight * 0.96 * 0.7;
            var margin = {top: height*0.07, right: width*0.5, bottom: height*0.11, left:width*0.05},
                graph_width = width  - margin.left - margin.right,
                graph_height = height - margin.top - 1.5*margin.bottom;
            x_modal.range([0, graph_width]);
            y_modal.range([graph_height, 0]);
            // append the svg obgect to the body of the page
            // appends a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            // define the line
            var valueline = d3.line()
                .x(function (d) {
                    return x_modal(d.TIME);
                })
                .y(function (d) {
                    return y_modal(d.Value);
                });

            var valueline2 = d3.line()
                .x(function (d) {
                    return x_modal(d.TIME);
                })
                .y(function (d) {
                    return y_modal(d.Value);
                });
            var svg = d3.select("#modal_svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top);

            var g = svg.select("#modal_inside_g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Get the data

            // Add the valueline path.
            g.select("#wage_gap_line")
                .attr("d", valueline);

            g.select("#employ_line")
                .attr("d", valueline2);

            g.selectAll('.wage_dot')
                .attr("r", graph_width*0.005)
                .attr("cx", function (d) {
                    return x_modal(d.TIME);
                })
                .attr("cy", function (d) {
                    return y_modal(d.Value);
                });

            g.selectAll(".emp_dot")
                .attr("r", graph_width*0.005)
                .attr("class", "emp_dot")
                .attr("cx", function (d) {
                    return x_modal(d.TIME);
                })
                .attr("cy", function (d) {
                    return y_modal(d.Value);
                });

            // Add the X Axis
            g.select("#x_axis_modal")
                .attr("transform", "translate(0," + graph_height + ")")
                .call(d3.axisBottom(x_modal));

            // Add the Y Axis
            g.select("#y_axis_modal")
                .call(d3.axisLeft(y_modal));

           g.select(".legend")
                .attr("transform","translate(" + margin.left + "," + margin.top + ")")
                .style("font-size","12px");
           g.select("#emp_legend")
               .attr("x", graph_width*0.001)
               .attr("y", height - margin.bottom);
            g.select("#wage_legend")
                .attr("x", graph_width*0.6)
                .attr("y", height  - margin.bottom);

            g.select("#emp_dot_legend")
                .attr("cy", height - (margin.bottom*1.15))
                .attr("cx",(graph_width*0.001) - 10)
                .attr("r",graph_width*0.015);

            g.select("#wage_dot_legend")
                .attr("cy", height - (margin.bottom*1.15))
                .attr("cx",(graph_width*0.6) - 10)
                .attr("r",graph_width*0.015);

            g.select("#modal_graph_title")
                .attr("x", (graph_width/2) - margin.left )
                .attr("y", margin.top);

        }

        function data_for_country(country, data) {
            var temp = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if (row['LOCATION'] === country) {
                    temp.push(row);
                }
            }
            return temp;
        }
        function getMinMaxVals(data){
            var minMaxYear = [data[0]['TIME'],data[0]['TIME'] ];
            var minMaxPercentages = [data[0]['Value'],data[0]['Value'] ];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if(row['TIME'].getTime() < minMaxYear[0].getTime()) minMaxYear[0] = row['TIME'];
                else if(row['TIME'].getTime() > minMaxYear[1].getTime()) minMaxYear[1] = row['TIME'];
                if(row['Value'] < minMaxPercentages[0]) minMaxPercentages[0] = row['Value'];
                else if(row['Value'] > minMaxPercentages[1]) minMaxPercentages[1] = row['Value'];
            }

            return [minMaxYear, minMaxPercentages];
        }


        return {
            render: render,
            render_modal: render_modal
        }


    })
    (window, d3);
    window.addEventListener('resize', Chart.render);
    window.addEventListener('resize', Chart.render_modal);
    window.onclick = function (event) {
        var modal = document.getElementById('country_modal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


</script>